AWSTemplateFormatVersion: "2010-09-09"
Transform: "AWS::Serverless-2016-10-31"
Description: "Digital Identity Driving Permit Credential Issuer API"
Metadata:
  cfn-lint:
    config:
      ignore_checks:
        - W2031
        - W1020
        - E3020

Parameters:
  VpcStackName:
    Description: >
      The name of the stack that defines the VPC in which this container will
      run.
    Type: String
    Default: "cri-vpc"
  CodeSigningConfigArn:
    Type: String
    Default: "none"
    Description: >
      The ARN of the Code Signing Config to use, provided by the deployment pipeline
  Environment:
    Description: "The environment type"
    Type: "String"
    AllowedValues:
      - "dev"
      - "build"
      - "staging"
      - "integration"
      - "production"
    ConstraintDescription: must be dev, build, staging, integration or production
  PermissionsBoundary:
    Description: "The ARN of the permissions boundary to apply when creating IAM roles"
    Type: String
    Default: "none"
  AuditEventNamePrefix:
    Description: "The audit event name prefix"
    Type: AWS::SSM::Parameter::Value<String>
    Default: "/common-cri-parameters/AuditEventNamePrefix"
  CriIdentifier:
    Description: "The unique credential issuer identifier"
    Type: AWS::SSM::Parameter::Value<String>
    Default: "/common-cri-parameters/CriIdentifier"
  CommonStackName:
    Description: "The name of the stack containing the common CRI lambdas/infra"
    Type: String
    Default: "common-cri-api"
  ParameterPrefix:
    Type: String
    Default: "none"
    Description: If set the this value will be used for ParameterStore prefix instead of AWS::StackName
  DeploymentType:
    Type: String
    Default: "pipeline"
    Description: Private Api gateway resources are not be reachable in stacks deployed via pipelines, this override enables less restrictive settings for manual/pre-merge-test deployments.
  DeployAlarmsInDev:
    Description: "Set to the string value `true` to deploy alarms in a DEV environment"
    Type: String
    Default: false
  SupportManualURL:
    Description: "Link to the DL support manual"
    Type: String
    Default: 'https://govukverify.atlassian.net/wiki/spaces/FTFCRI/pages/3623583745/F2F+Support+Documentation'
  CreateMockTxmaResourcesOverride:
    Description: "Mock TXMA SQS Queue"
    Type: String
    Default: "false"
  LogGroupRetentionInDays:
    Description: "Retention for all log groups"
    Type: Number
    Default: "30"

Conditions:
  IsDeployedFromPipeline: !Equals
    - !Ref DeploymentType
    - "pipeline"
  # This is a special case fix to avoid setting this environment wide feature flag in dev.
  # As it becomes owned by the first stack using it. Remove once the feature flag is removed and feature is permanent.
  OverrideSettingOfEnvironmentWideFeatureFlag: !Equals
    - !Ref Environment
    - dev

  UsingCodeSigning:
    Fn::Not:
      - Fn::Equals:
          - !Ref CodeSigningConfigArn
          - "none"
  # Don't send logs in dev to avoid overwhelming the destination with debug
  LogSendingEnabled: !And
    - !Not [!Equals [!Ref Environment, "dev"]]
    - !Condition IsDeployedFromPipeline
  IsProdEnvironment: !Equals
    - !Ref Environment
    - production
  AddProvisionedConcurrency: !Not
    - !Equals
      - !FindInMap [ProvisionedConcurrency, Environment, !Ref 'Environment']
      -  0
  UsePermissionsBoundary:
    Fn::Not:
      - Fn::Equals:
          - !Ref PermissionsBoundary
          - "none"
  UseParameterPrefix:
    Fn::Not:
      - Fn::Equals:
          - !Ref ParameterPrefix
          - "none"
  IsNotDevelopment: !Or
    - !Equals [ !Ref Environment, build ]
    - !Equals [ !Ref Environment, staging ]
    - !Equals [ !Ref Environment, integration ]
    - !Equals [ !Ref Environment, production ]
  DeployAlarms: !Or
    - Condition: IsNotDevelopment
    - !Equals [!Ref DeployAlarmsInDev, true]

  CreateMockTxmaResources:
    Fn::And:
      - !Equals [!Ref Environment, "dev"]
      - !Equals [ !Ref CreateMockTxmaResourcesOverride, "true" ]

  IsCAEnvironment:
    Fn::Or:
      - !Equals [!Ref Environment, "production"]
      - !Equals [!Ref Environment, "staging"]

Globals:
  Function:
    CodeSigningConfigArn: !If
      - UsingCodeSigning
      - !Ref CodeSigningConfigArn
      - !Ref AWS::NoValue
    PermissionsBoundary: !If
      - UsePermissionsBoundary
      - !Ref PermissionsBoundary
      - !Ref AWS::NoValue
    VpcConfig:
      SecurityGroupIds:
        - !ImportValue cri-vpc-LambdaSecurityGroup
      SubnetIds: !Split [ ",", !ImportValue cri-vpc-PrivateSubnets ]
    Timeout: 30 # seconds
    Runtime: java17
    AutoPublishAlias: live
    Tracing: Active
    MemorySize: !FindInMap [MemorySizeMapping, Environment, !Ref 'Environment']
    Architectures:
      - arm64
    Environment:
      Variables:
        AWS_LAMBDA_EXEC_WRAPPER: /opt/dynatrace
        DT_CONNECTION_AUTH_TOKEN: !Sub
          - '{{resolve:secretsmanager:${SecretArn}:SecretString:DT_CONNECTION_AUTH_TOKEN}}'
          - SecretArn: !FindInMap [ EnvironmentConfiguration, !Ref Environment, dynatraceSecretArn ]
        DT_CONNECTION_BASE_URL: !Sub
          - '{{resolve:secretsmanager:${SecretArn}:SecretString:DT_CONNECTION_BASE_URL}}'
          - SecretArn: !FindInMap [ EnvironmentConfiguration, !Ref Environment, dynatraceSecretArn ]
        DT_CLUSTER_ID: !Sub
          - '{{resolve:secretsmanager:${SecretArn}:SecretString:DT_CLUSTER_ID}}'
          - SecretArn: !FindInMap [ EnvironmentConfiguration, !Ref Environment, dynatraceSecretArn ]
        DT_LOG_COLLECTION_AUTH_TOKEN: !Sub
          - '{{resolve:secretsmanager:${SecretArn}:SecretString:DT_LOG_COLLECTION_AUTH_TOKEN}}'
          - SecretArn: !FindInMap [ EnvironmentConfiguration, !Ref Environment, dynatraceSecretArn ]
        DT_TENANT: !Sub
          - '{{resolve:secretsmanager:${SecretArn}:SecretString:DT_TENANT}}'
          - SecretArn: !FindInMap [ EnvironmentConfiguration, !Ref Environment, dynatraceSecretArn ]
        DT_OPEN_TELEMETRY_ENABLE_INTEGRATION: "true"
        JAVA_TOOL_OPTIONS: -XX:+TieredCompilation -XX:TieredStopAtLevel=1
        AWS_STACK_NAME: !Sub ${AWS::StackName}
        POWERTOOLS_LOG_LEVEL: INFO
        SQS_AUDIT_EVENT_PREFIX: !Ref AuditEventNamePrefix
        SQS_AUDIT_EVENT_QUEUE_URL: !If
          - CreateMockTxmaResources
          - !GetAtt MockAuditEventQueue.QueueUrl
          - Fn::ImportValue: AuditEventQueueUrl
        POWERTOOLS_METRICS_NAMESPACE: !Ref CriIdentifier
        COMMON_PARAMETER_NAME_PREFIX: !Ref CommonStackName
        ENVIRONMENT: !Ref Environment
        PARAMETER_PREFIX: !If [UseParameterPrefix, !Ref ParameterPrefix , !Ref AWS::StackName]
    Layers:
      - !Sub
        - '{{resolve:secretsmanager:${SecretArn}:SecretString:JAVA_LAYER}}' # or NODEJS_LAYER or PYTHON_LAYER
        - SecretArn: !FindInMap [ EnvironmentConfiguration, !Ref Environment, dynatraceSecretArn ]

Mappings:
  EnvironmentConfiguration:
    dev:
      dynatraceSecretArn: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceNonProductionVariables
    build:
      dynatraceSecretArn: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceNonProductionVariables
    staging:
      dynatraceSecretArn: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceNonProductionVariables
    integration:
      dynatraceSecretArn: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceNonProductionVariables
    production:
      dynatraceSecretArn: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceProductionVariables

  MemorySizeMapping:
    Environment:
      dev: 2048
      build: 4096
      staging: 2048
      integration: 2048
      production: 4096

  MaxJwtTtlMapping:
    Environment:
      dev: "6"
      build: "6"
      staging: "6"
      integration: "6"
      production: "6"

  VcExpiryRemoved:
    Environment:
      dev: "true"
      build: "true"
      staging: "true"
      integration: "true"
      production: "true"

  VcContainsUniqueIdMapping:
    Environment:
      dev: "true"
      build: "true"
      staging: "true"
      integration: "true"
      production: "true"

  JwtTtlUnitMapping:
    Environment:
      dev: MONTHS
      build: MONTHS
      staging: MONTHS
      integration: MONTHS
      production: MONTHS

  # Set as EnvVar on the CheckLambda
  # devEnvironmentOnlyEnhancedDebug changes CRI behaviour
  # Do not enable outside of Dev
  DevEnvironmentOnlyEnhancedDebugMappingEnvVar:
    Environment:
      dev: "false"
      build: "false"
      staging: "false"
      integration: "false"
      production: "false"

  # Set as EnvVar on the CheckLambda
  DVAPerformanceStubEnabledEnvVar:
    Environment:
      dev: "true"
      build: "true"
      staging: "false"
      integration: "false"
      production: "false"

  LogDVAResponseEnvVar:
    Environment:
      dev: "false"
      build: "false"
      staging: "false"
      integration: "false"
      production: "false"

  # Set as EnvVar on the CheckLambda
  DVLAPasswordRotationEnabledEnvVar:
    Environment:
      dev: "true"
      build: "true"
      staging: "false"
      integration: "false"
      production: "true"

  dvlaPasswordRotationWindow:
    Environment:
      dev: "rate(4 hours)"
      build: "cron(0 10 ? 1/2 TUE#1 *)"
      staging: "cron(0 10 ? 1/2 TUE#1 *)" #This value will need updated to match build manually upon rotation
      integration: "cron(0 10 ? 1/2 TUE#1 *)"
      production: "cron(0 10 ? 1/2 TUE#1 *)"

  ProvisionedConcurrency:
    Environment:
      dev: 0
      build: 1
      staging: 1
      integration: 1
      production: 1

  DrivingPermitCriAudienceMapping:
    Environment:
      dev: "https://review-d.dev.account.gov.uk"
      build: "https://review-d.build.account.gov.uk"
      staging: "https://review-d.staging.account.gov.uk"
      integration: "https://review-d.integration.account.gov.uk"
      production: "https://review-d.account.gov.uk"

  FeatureFlagMapping:
    dev:
      VcExpiryRemoved: "true"
      VcContainsUniqueIdMapping: "true"
      IncludeKidInVc: "true"
      hasCA: "false"
    build:
      VcExpiryRemoved: "true"
      VcContainsUniqueIdMapping: "true"
      IncludeKidInVc: "false"
      hasCA: "false"
    staging:
      VcExpiryRemoved: "true"
      VcContainsUniqueIdMapping: "true"
      IncludeKidInVc: "false"
      hasCA: "true"
    integration:
      VcExpiryRemoved: "true"
      VcContainsUniqueIdMapping: "true"
      IncludeKidInVc: "false"
      hasCA: "false"
    production:
      VcExpiryRemoved: "true"
      VcContainsUniqueIdMapping: "true"
      IncludeKidInVc: "false"
      hasCA: "true"

Resources:

####################################################################
#                                                                  #
# API Gateway                                                      #
#                                                                  #
####################################################################

  PublicDrivingPermitApi:
    Type: AWS::Serverless::Api
    Properties:
      Description: Public Driving Permit CRI API
      MethodSettings:
        - LoggingLevel: INFO
          ResourcePath: '/*'
          HttpMethod: '*'
          # Disable data trace in production to avoid logging customer sensitive information
          DataTraceEnabled: !If [IsProdEnvironment, false, true]
          MetricsEnabled: true
          ThrottlingRateLimit: 200
          ThrottlingBurstLimit: 400
      AccessLogSetting:
        DestinationArn: !Sub 'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:${PublicDrivingPermitApiAccessLogGroup}'
        Format: >-
          {
          "requestId":"$context.requestId",
          "ip":"$context.identity.sourceIp",
          "requestTime":"$context.requestTime",
          "httpMethod":"$context.httpMethod",
          "path":"$context.path",
          "routeKey":"$context.routeKey",
          "status":"$context.status",
          "protocol":"$context.protocol",
          "responseLatency":"$context.responseLatency",
          "responseLength":"$context.responseLength"
          }
      TracingEnabled: true
      Name: !Sub "${AWS::StackName}-PublicDLApi"
      StageName: !Ref Environment
      DefinitionBody:
        openapi: "3.0.1" # workaround to get `sam validate` to work
        paths: # workaround to get `sam validate` to work
          /never-created:
            options: { } # workaround to get `sam validate` to work
        Fn::Transform:
          Name: AWS::Include
          Parameters:
            Location: './public-api.yaml'
        components:
          schemas:
            TokenResponse:
              title: AccessToken
              required:
                - "access_token"
                - "expires_in"
              type: "object"
              properties:
                access_token:
                  type: string
                  description: The Access Token for the given token request.
                token_type:
                  type: string
                  description: The Token Type issued.
                  example: Bearer
                expires_in:
                  type: string
                  description: The expiry time, in seconds.
                  example: '3600'
                refresh_token:
                  type: string
                  description: The refresh token is optional, not currently applicable.
            Error:
              title: "Error Schema"
              type: "object"
              properties:
                message:
                  type: "string"
          securitySchemes:
            !If
            - IsDeployedFromPipeline
            -
              api_key:
                type: "apiKey"
                name: "x-api-key"
                in: "header"
            - !Ref "AWS::NoValue"
      OpenApiVersion: 3.0.1
      EndpointConfiguration:
        Type: REGIONAL

  PublicDrivingPermitApiAccessLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/apigateway/${AWS::StackName}-${PublicDrivingPermitApi}-public-AccessLogs
      RetentionInDays: !Ref LogGroupRetentionInDays

  PublicDrivingPermitApiAccessLogGroupSubscriptionFilterCsls:
    Type: AWS::Logs::SubscriptionFilter
    Condition: LogSendingEnabled
    Properties:
      DestinationArn: "arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython"
      FilterPattern: ""
      LogGroupName: !Ref PublicDrivingPermitApiAccessLogGroup

  PrivateDrivingPermitApi:
    Type: AWS::Serverless::Api
    Properties:
      Description: Private Driving Permit CRI API
      MethodSettings:
        - LoggingLevel: INFO
          ResourcePath: '/*'
          HttpMethod: '*'
          # Disable data trace in production to avoid logging customer sensitive information
          DataTraceEnabled: !If [IsProdEnvironment, false, true]
          MetricsEnabled: true
          ThrottlingRateLimit: 200
          ThrottlingBurstLimit: 400
      AccessLogSetting:
        DestinationArn: !Sub 'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:${PrivateDrivingPermitApiAccessLogGroup}'
        Format: >-
          {
          "requestId":"$context.requestId",
          "ip":"$context.identity.sourceIp",
          "requestTime":"$context.requestTime",
          "httpMethod":"$context.httpMethod",
          "path":"$context.path",
          "routeKey":"$context.routeKey",
          "status":"$context.status",
          "protocol":"$context.protocol",
          "responseLatency":"$context.responseLatency",
          "responseLength":"$context.responseLength"
          }
      TracingEnabled: true
      Name: !Sub "${AWS::StackName}-PrivateDLApi"
      StageName: !Ref Environment
      DefinitionBody:
        openapi: "3.0.1" # workaround to get `sam validate` to work
        paths: # workaround to get `sam validate` to work
          /never-created:
            options: { } # workaround to get `sam validate` to work
        Fn::Transform:
          Name: AWS::Include
          Parameters:
            Location: './private-api.yaml'
      OpenApiVersion: 3.0.1
      EndpointConfiguration:
        Type: !If [IsDeployedFromPipeline, PRIVATE, REGIONAL]
      Auth:
        ResourcePolicy:
          CustomStatements:
            - Action: 'execute-api:Invoke'
              Effect: Allow
              Principal: '*'
              Resource:
                - 'execute-api:/*'
            - !If
              - IsDeployedFromPipeline
              - Action: 'execute-api:Invoke'
                Effect: Deny
                Principal: '*'
                Resource:
                  - 'execute-api:/*'
                Condition:
                  StringNotEquals:
                    aws:SourceVpce:
                      - Fn::ImportValue:
                          !Sub "${VpcStackName}-ApiGatewayVpcEndpointId"
              - !Ref AWS::NoValue

  PrivateDrivingPermitApiAccessLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/apigateway/${AWS::StackName}-${PrivateDrivingPermitApi}-private-AccessLogs
      RetentionInDays: !Ref LogGroupRetentionInDays

  PrivateDrivingPermitApiAccessLogGroupSubscriptionFilter:
    Type: AWS::Logs::SubscriptionFilter
    Condition: LogSendingEnabled
    Properties:
      DestinationArn: "arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython"
      FilterPattern: ""
      LogGroupName: !Ref PrivateDrivingPermitApiAccessLogGroup

####################################################################
#                                                                  #
# Identity checking Function                                       #
#                                                                  #
####################################################################

  DrivingPermitCheckingFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../../lambdas/drivingpermitcheck
      Handler: uk.gov.di.ipv.cri.drivingpermit.api.handler.DrivingPermitHandler::handleRequest
      Environment:
        Variables:
          POWERTOOLS_SERVICE_NAME: !Sub "${CriIdentifier}-drivingpermitcheck"
          DVA_PERFORMANCE_STUB_IN_USE: !FindInMap [DVAPerformanceStubEnabledEnvVar, Environment, !Ref 'Environment']
          LOG_DVA_RESPONSE: !FindInMap [LogDVAResponseEnvVar, Environment, !Ref 'Environment']
          DVLA_PASSWORD_ROTATION_ENABLED: !FindInMap [ DVLAPasswordRotationEnabledEnvVar, Environment, !Ref 'Environment' ]
          DEV_ENVIRONMENT_ONLY_ENHANCED_DEBUG: !FindInMap [DevEnvironmentOnlyEnhancedDebugMappingEnvVar, Environment, !Ref Environment ]
          HAS_CA: !FindInMap [ FeatureFlagMapping, !Ref Environment, hasCA ]
          SIGNING_CERTIFICATE_ARN: !If
            - IsCAEnvironment
            - Fn::ImportValue: acm-infra-DLCRISigningCertificateArn
            - !Ref "AWS::NoValue"
          TLS_CERTIFICATE_ARN:  !If
            - IsCAEnvironment
            - Fn::ImportValue: acm-infra-DLCRIMtlsCertificateArn
            - !Ref "AWS::NoValue"
          SIGNING_KEY_ID: !ImportValue acm-infra-DvaSigningKeyId
          ENCRYPTION_KEY_ID: !ImportValue acm-infra-DvaEncryptionKeyId
      Policies:
        - AWSLambdaBasicExecutionRole
        - AWSXrayWriteOnlyAccess
        - DynamoDBWritePolicy:
            TableName: !Sub "{{resolve:ssm:/${CommonStackName}/SessionTableName}}"
        - DynamoDBReadPolicy:
            TableName: !Sub "{{resolve:ssm:/${CommonStackName}/SessionTableName}}"
        - DynamoDBReadPolicy:
            TableName: !Sub "{{resolve:ssm:/${CommonStackName}/PersonIdentityTableName}}"
        - DynamoDBWritePolicy:
            TableName: !Sub "{{resolve:ssm:/${CommonStackName}/PersonIdentityTableName}}"
        - DynamoDBWritePolicy:
            TableName: !Ref DocumentCheckResultTable
        - DynamoDBReadPolicy:
            TableName: !Ref DvlaTokenTable
        - DynamoDBWritePolicy:
            TableName: !Ref DvlaTokenTable
        - Statement:
            Effect: Allow
            Action:
              - "kms:Sign"
            Resource: !ImportValue core-infrastructure-CriVcSigningKey1Arn
        - Statement:
            Effect: Allow
            Action:
              - "kms:Sign"
            Resource: !ImportValue acm-infra-DvaSigningKeyArn
        - Statement:
            Effect: Allow
            Action:
              - kms:Decrypt
              - kms:GenerateDataKey
            Resource: !If
              - CreateMockTxmaResources
              - !GetAtt MockAuditEventQueueEncryptionKey.Arn
              - Fn::ImportValue: AuditEventQueueEncryptionKeyArn
        - Statement:
            Effect: Allow
            Action:
              - kms:Decrypt
              - kms:GenerateDataKey
            Resource: !ImportValue acm-infra-DvaEncryptionKeyArn
        - Statement:
            - Effect: Allow
              Action:
                - ssm:GetParameter
              Resource:
                - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${AWS::StackName}/DocumentCheckResultTableName"
                - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${AWS::StackName}/DVLA/TokenTableName"

                - !Sub
                  - "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${PREFIX}/DVA*"
                  - PREFIX: !If [UseParameterPrefix, !Ref ParameterPrefix , !Ref AWS::StackName]
                - !Sub
                  - "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${PREFIX}/DVLA*"
                  - PREFIX: !If [UseParameterPrefix, !Ref ParameterPrefix , !Ref AWS::StackName]

                - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${CommonStackName}/SessionTableName"
                - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${CommonStackName}/PersonIdentityTableName"
                - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${CommonStackName}/SessionTtl"
                - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${CommonStackName}/verifiable-credential/issuer"
        - Statement:
            - Effect: Allow
              Action:
                - ssm:GetParametersByPath
              Resource:
                - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${AWS::StackName}/clients/*"
        - Statement:
            - Sid: ReadSecretsPolicy
              Effect: Allow
              Action:
                - 'secretsmanager:GetSecretValue'
              Resource:
                - !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:/${AWS::StackName}/DVLA/password*"
        - Statement:
            - Effect: Allow
              Action:
                - ssm:GetParametersByPath
              Resource:
                - !Sub
                  - "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${PREFIX}/DVA/HttpClient"
                  - PREFIX: !If [UseParameterPrefix, !Ref ParameterPrefix , !Ref AWS::StackName]
        - Statement:
            - Effect: Allow
              Action:
                - ssm:GetParametersByPath
              Resource:
                - !Sub
                  - "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${PREFIX}/DVA/JWE"
                  - PREFIX: !If [UseParameterPrefix, !Ref ParameterPrefix , !Ref AWS::StackName]
        - Statement:
            - Effect: Allow
              Action:
                - ssm:GetParametersByPath
              Resource:
                - !Sub
                  - "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${PREFIX}/DVA/JWS"
                  - PREFIX: !If [UseParameterPrefix, !Ref ParameterPrefix , !Ref AWS::StackName]
        - Statement:
            - Effect: Allow
              Action:
                - ssm:GetParametersByPath
              Resource:
                - !Sub
                  - "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${PREFIX}/DVLA"
                  - PREFIX: !If [UseParameterPrefix, !Ref ParameterPrefix , !Ref AWS::StackName]
        - Statement:
            - Effect: Allow
              Action: !If
                - IsCAEnvironment
                - acm:ExportCertificate
                - ssm:GetParameter
              Resource: !If
                - IsCAEnvironment
                - !ImportValue acm-infra-DLCRISigningCertificateArn
                - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${AWS::StackName}/DocumentCheckResultTableName"
        - Statement:
            - Effect: Allow
              Action: !If
                - IsCAEnvironment
                - acm:ExportCertificate
                - ssm:GetParameter
              Resource: !If
                - IsCAEnvironment
                - !ImportValue acm-infra-DLCRIMtlsCertificateArn
                - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${AWS::StackName}/DocumentCheckResultTableName"

        - SQSSendMessagePolicy:
            QueueName: !If [CreateMockTxmaResources, !GetAtt MockAuditEventQueue.QueueName, !ImportValue AuditEventQueueName]
      ProvisionedConcurrencyConfig:
        !If
        - AddProvisionedConcurrency
        - ProvisionedConcurrentExecutions: !FindInMap [ProvisionedConcurrency, Environment, !Ref 'Environment']
        - !Ref AWS::NoValue

  DrivingPermitCheckingFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${DrivingPermitCheckingFunction}"
      RetentionInDays: !Ref LogGroupRetentionInDays

  DrivingPermitCheckingFunctionLogGroupSubscriptionFilter:
    Type: AWS::Logs::SubscriptionFilter
    Condition: LogSendingEnabled
    Properties:
      DestinationArn: "arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython"
      FilterPattern: ""
      LogGroupName: !Ref DrivingPermitCheckingFunctionLogGroup

  DrivingPermitCheckingFunctionPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt DrivingPermitCheckingFunction.Arn
      Principal: apigateway.amazonaws.com

####################################################################
#                                                                  #
# Issue Credential Function                                        #
#                                                                  #
####################################################################

  IssueCredentialFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: uk.gov.di.ipv.cri.drivingpermit.api.handler.IssueCredentialHandler::handleRequest
      CodeUri: ../../lambdas/issuecredential
      Environment:
        Variables:
          POWERTOOLS_SERVICE_NAME: !Sub "${CriIdentifier}-issuecredential"
          ENV_VAR_FEATURE_FLAG_VC_EXPIRY_REMOVED: !FindInMap [ FeatureFlagMapping, !Ref Environment, VcExpiryRemoved ]
          ENV_VAR_FEATURE_FLAG_VC_CONTAINS_UNIQUE_ID: !FindInMap [ FeatureFlagMapping, !Ref Environment, VcContainsUniqueIdMapping ]
          INCLUDE_VC_KID: !FindInMap [ FeatureFlagMapping, !Ref Environment, IncludeKidInVc ]
      Policies:
        - AWSLambdaBasicExecutionRole
        - AWSXrayWriteOnlyAccess
        - DynamoDBReadPolicy:
            TableName: !Sub "{{resolve:ssm:/${CommonStackName}/SessionTableName}}"
        - DynamoDBReadPolicy:
            TableName: !Sub "{{resolve:ssm:/${CommonStackName}/PersonIdentityTableName}}"
        - DynamoDBReadPolicy:
            TableName: !Ref DocumentCheckResultTable
        - Statement:
            Effect: Allow
            Action:
              - "kms:Sign"
            Resource: !ImportValue core-infrastructure-CriVcSigningKey1Arn
        - SQSSendMessagePolicy:
            QueueName: !If [CreateMockTxmaResources, !GetAtt MockAuditEventQueue.QueueName, !ImportValue AuditEventQueueName]
        - Statement:
            Effect: Allow
            Action:
              - ssm:GetParameter
            Resource:
              - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${AWS::StackName}/DocumentCheckResultTableName"
              - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${AWS::StackName}/MaxJwtTtl"
              - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${AWS::StackName}/JwtTtlUnit"
              - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${AWS::StackName}/verifiable-credential/issuer"
              - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${AWS::StackName}/verifiableCredentialKmsSigningKeyId"
              - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${CommonStackName}/verifiableCredentialKmsSigningKeyId"
              - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${CommonStackName}/verifiable-credential/issuer"
              - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${CommonStackName}/SessionTableName"
              - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${CommonStackName}/SessionTtl"
              - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${CommonStackName}/PersonIdentityTableName"
              - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/release-flags/vc-expiry-removed"
              - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${AWS::StackName}/release-flags/vc-contains-unique-id"
        - Statement:
            - Sid: ReadSecretsPolicy
              Effect: Allow
              Action:
                - 'secretsmanager:GetSecretValue'
              Resource:
                - !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:/${AWS::StackName}/DVLA/password*"

        - Statement:
            Effect: Allow
            Action:
              - kms:Decrypt
              - kms:GenerateDataKey
            Resource: !If
              - CreateMockTxmaResources
              - !GetAtt MockAuditEventQueueEncryptionKey.Arn
              - Fn::ImportValue: AuditEventQueueEncryptionKeyArn
      ProvisionedConcurrencyConfig:
        !If
        - AddProvisionedConcurrency
        - ProvisionedConcurrentExecutions: !FindInMap [ProvisionedConcurrency, Environment, !Ref 'Environment']
        - !Ref AWS::NoValue

  IssueCredentialFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${IssueCredentialFunction}"
      RetentionInDays: !Ref LogGroupRetentionInDays

  IssueCredentialFunctionLogGroupSubscriptionFilter:
    Type: AWS::Logs::SubscriptionFilter
    Condition: LogSendingEnabled
    Properties:
      DestinationArn: "arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython"
      FilterPattern: ""
      LogGroupName: !Ref IssueCredentialFunctionLogGroup

  IssueCredentialFunctionPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt IssueCredentialFunction.Arn
      Principal: apigateway.amazonaws.com

  ####################################################################
  #                                                                  #
  # Password Renewal Function                                        #
  #                                                                  #
  ####################################################################

  PasswordRenewalFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../../lambdas/passwordRenewal
      Handler: uk.gov.di.ipv.cri.drivingpermit.event.handler.PasswordRenewalHandler::handleRequest
      Environment:
        Variables:
          POWERTOOLS_SERVICE_NAME: !Sub "${CriIdentifier}-passwordRenewal"
          DVLA_PASSWORD_ROTATION_ENABLED: !FindInMap [ DVLAPasswordRotationEnabledEnvVar, Environment, !Ref 'Environment' ]
      Policies:
        - AWSLambdaBasicExecutionRole
        - AWSXrayWriteOnlyAccess
        - SSMParameterReadPolicy:
            ParameterName: !Sub "${AWS::StackName}/verifiable-credential/issuer"
        - Statement:
            - Sid: ReadSecretsPolicy
              Effect: Allow
              Action:
                - 'secretsmanager:GetSecretValue'
              Resource:
                - !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:/${AWS::StackName}/DVLA/password*"

        - Statement:
            - Sid: UpdateSecretsPolicy
              Effect: Allow
              Action:
                - 'secretsmanager:UpdateSecret'
              Resource:
                - !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:/${AWS::StackName}/DVLA/password*"
        - Statement:
            - Sid: PutSecretValuePolicy
              Effect: Allow
              Action:
                - 'secretsmanager:PutSecretValue'
              Resource:
                - !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:/${AWS::StackName}/DVLA/password*"

        - Statement:
            - Effect: Allow
              Action:
                - ssm:GetParameter
              Resource:
                - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${AWS::StackName}/DVLA/TokenTableName"
                - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${AWS::StackName}/DVLA/passwordPath"
        - Statement:
            - Effect: Allow
              Action:
                - ssm:GetParametersByPath
              Resource:
                - !Sub
                  - "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${PREFIX}/DVLA"
                  - PREFIX: !If [UseParameterPrefix, !Ref ParameterPrefix , !Ref AWS::StackName]

  PasswordRenewalFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${PasswordRenewalFunction}"
      RetentionInDays: !Ref LogGroupRetentionInDays

  PasswordRenewalFunctionLogGroupSubscriptionFilterCsls:
    Type: AWS::Logs::SubscriptionFilter
    Condition: LogSendingEnabled
    Properties:
      DestinationArn: "arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython"
      FilterPattern: ""
      LogGroupName: !Ref PasswordRenewalFunctionLogGroup

  PasswordRenewalRotationSchedule:
    Type: AWS::SecretsManager::RotationSchedule
    DependsOn:
      - PasswordRenewalFunctionPermission
    Properties:
      RotateImmediatelyOnUpdate: false
      SecretId: !Ref DVLAPasswordSecret
      RotationLambdaARN: !GetAtt PasswordRenewalFunction.Arn
      RotationRules:
        Duration: 1h
        ScheduleExpression: !FindInMap [ dvlaPasswordRotationWindow, Environment, !Ref Environment ]

  PasswordRenewalFunctionPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt PasswordRenewalFunction.Arn
      Principal: secretsmanager.amazonaws.com

####################################################################
#                                                                  #
# Cert expiry reminder function                                    #
#                                                                  #
####################################################################

  CertExpiryReminderFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: uk.gov.di.ipv.cri.drivingpermit.certreminder.handler.CertExpiryReminderHandler::handleRequest
      CodeUri: ../../lambdas/certexpiryreminder
      Environment:
        Variables:
          POWERTOOLS_SERVICE_NAME: !Sub "${CriIdentifier}-CertExpiryReminder"
      Policies:
        - AWSLambdaBasicExecutionRole
        - AWSXrayWriteOnlyAccess
        - Statement:
            Effect: Allow
            Action:
              - "kms:Sign"
            Resource: !ImportValue core-infrastructure-CriVcSigningKey1Arn
        - SQSSendMessagePolicy:
            QueueName: !If [CreateMockTxmaResources, !GetAtt MockAuditEventQueue.QueueName, !ImportValue AuditEventQueueName]
        - Statement:
            - Effect: Allow
              Action:
                - ssm:GetParametersByPath
              Resource:
                - !Sub
                  - "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${PREFIX}/DVA/HttpClient"
                  - PREFIX: !If [UseParameterPrefix, !Ref ParameterPrefix , !Ref AWS::StackName]
        - Statement:
            - Effect: Allow
              Action:
                - ssm:GetParametersByPath
              Resource:
                - !Sub
                  - "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${PREFIX}/DVA/JWE"
                  - PREFIX: !If [UseParameterPrefix, !Ref ParameterPrefix , !Ref AWS::StackName]
        - Statement:
            - Effect: Allow
              Action:
                - ssm:GetParametersByPath
              Resource:
                - !Sub
                  - "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${PREFIX}/DVA/JWS"
                  - PREFIX: !If [UseParameterPrefix, !Ref ParameterPrefix , !Ref AWS::StackName]
        - Statement:
            - Effect: Allow
              Action:
                - ssm:GetParametersByPath
              Resource:
                - !Sub
                  - "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${PREFIX}/DVA/heldByDVA"
                  - PREFIX: !If [UseParameterPrefix, !Ref ParameterPrefix , !Ref AWS::StackName]
        - Statement:
            Effect: Allow
            Action:
              - kms:Decrypt
              - kms:GenerateDataKey
            Resource: !If
              - CreateMockTxmaResources
              - !GetAtt MockAuditEventQueueEncryptionKey.Arn
              - Fn::ImportValue: AuditEventQueueEncryptionKeyArn

  CertExpiryReminderFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${CertExpiryReminderFunction}"
      RetentionInDays: !Ref LogGroupRetentionInDays

  CertExpiryReminderFunctionLogGroupSubscriptionFilter:
    Type: AWS::Logs::SubscriptionFilter
    Condition: LogSendingEnabled
    Properties:
      DestinationArn: "arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython"
      FilterPattern: ""
      LogGroupName: !Ref CertExpiryReminderFunctionLogGroup

  CertExpiryReminderFunctionPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt CertExpiryReminderFunction.Arn
      Principal: scheduler.amazonaws.com

  CertExpiryReminderEventRule:
    Type: AWS::Events::Rule
    Properties:
      Description: "Daily Lambda trigger"
      ScheduleExpression: "cron(0 12 ? * MON-FRI *)"
      State: ENABLED
      Targets:
        - Arn: !GetAtt CertExpiryReminderFunction.Arn
          Id: scheduled-Cert-Expiry-event
          RetryPolicy:
            MaximumRetryAttempts: 0


  #############################
  # New consumer queue for testing TxMA header
  #############################

  MockAuditEventQueue:
    Type: AWS::SQS::Queue
    Condition: CreateMockTxmaResources
    Properties:
      MessageRetentionPeriod: 3600 # 1 hour
      KmsMasterKeyId: !Ref MockAuditEventQueueEncryptionKeyAlias
      RedriveAllowPolicy:
        redrivePermission: denyAll
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt MockAuditEventDeadLetterQueue.Arn
        maxReceiveCount: 10

  MockAuditEventDeadLetterQueue:
    Type: AWS::SQS::Queue
    Condition: CreateMockTxmaResources
    Properties:
      MessageRetentionPeriod: 604800 # 7 days
      KmsMasterKeyId: !Ref MockAuditEventQueueEncryptionKeyAlias

  MockAuditEventQueueEncryptionKey:
    Type: AWS::KMS::Key
    Condition: CreateMockTxmaResources
    Properties:
      Description: Symmetric key used to encrypt audit messages at rest in SQS
      EnableKeyRotation: true
      KeySpec: SYMMETRIC_DEFAULT

  MockAuditEventQueueEncryptionKeyAlias:
    Type: AWS::KMS::Alias
    Condition: CreateMockTxmaResources
    Properties:
      AliasName: !Sub alias/${AWS::StackName}/auditEventQueueEncryptionKey
      TargetKeyId: !Ref MockAuditEventQueueEncryptionKey

####################################################################
#                                                                  #
# Database Tables                                                  #
#                                                                  #
####################################################################

  DocumentCheckResultTable:
    Type: "AWS::DynamoDB::Table" # enable encryption with customer managed kms key. Will need new kms key
    Properties:
      TableName: !Sub "document-check-${AWS::StackName}"
      BillingMode: "PAY_PER_REQUEST"
      AttributeDefinitions:
        - AttributeName: "sessionId"
          AttributeType: "S"
      KeySchema:
        - AttributeName: "sessionId"
          KeyType: "HASH"
      TimeToLiveSpecification:
        AttributeName: expiry
        Enabled: true

  DvlaTokenTable:
    Type: "AWS::DynamoDB::Table" # enable encryption with customer managed kms key. Will need new kms key
    Properties:
      TableName: !Sub "dvla-token-${AWS::StackName}"
      BillingMode: "PAY_PER_REQUEST"
      AttributeDefinitions:
        - AttributeName: "id"
          AttributeType: "S"
      KeySchema:
        - AttributeName: "id"
          KeyType: "HASH"
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true
      SSESpecification:
        SSEEnabled: true
        SSEType: KMS

####################################################################
#                                                                  #
# API config                                                       #
#                                                                  #
####################################################################

  PublicDrivingPermitApiUsagePlan:
    Type: AWS::ApiGateway::UsagePlan
    Condition: IsDeployedFromPipeline
    DependsOn:
      - PublicDrivingPermitApiStage
    Properties:
      ApiStages:
        - ApiId: !Ref PublicDrivingPermitApi
          Stage: !Ref Environment
      Quota:
        Limit: 500000
        Period: DAY
      Throttle:
        RateLimit: 200 # allowed requests per second
        BurstLimit: 400 # requests the API can handle concurrently

  PrivateDrivingPermitApiUsagePlan:
    Type: AWS::ApiGateway::UsagePlan
    Condition: IsDeployedFromPipeline
    DependsOn:
      - PrivateDrivingPermitApiStage
    Properties:
      ApiStages:
        - ApiId: !Ref PrivateDrivingPermitApi
          Stage: !Ref Environment
      Quota:
        Limit: 500000
        Period: DAY
      Throttle:
        RateLimit: 200 # allowed requests per second
        BurstLimit: 400 # requests the API can handle concurrently

  LinkUsagePlanApiKey1:
    Type: AWS::ApiGateway::UsagePlanKey
    Condition: IsDeployedFromPipeline
    Properties:
      KeyId: !ImportValue core-infrastructure-ApiKey1
      KeyType: API_KEY
      UsagePlanId: !Ref PublicDrivingPermitApiUsagePlan

  LinkUsagePlanApiKey2:
    Type: AWS::ApiGateway::UsagePlanKey
    Condition: IsDeployedFromPipeline
    Properties:
      KeyId: !ImportValue core-infrastructure-ApiKey2
      KeyType: API_KEY
      UsagePlanId: !Ref PublicDrivingPermitApiUsagePlan

####################################################################
#                                                                  #
# Parameters                                                       #
#                                                                  #
####################################################################

  ParameterReleaseFlagsVcExpiryRemoved:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !If
        - OverrideSettingOfEnvironmentWideFeatureFlag
        - !Sub "/${AWS::StackName}/release-flags-vc-expiry-removed-not-used-in-dev"
        - !Sub "/release-flags/vc-expiry-removed"
      Value: !FindInMap [ VcExpiryRemoved, Environment, !Ref Environment ]
      Type: String
      Description: Expiry date release toggle

  ReleaseFlagsVcContainsUniqueIdParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/release-flags/vc-contains-unique-id"
      Value: !FindInMap [ VcContainsUniqueIdMapping, Environment, !Ref Environment ]
      Type: String
      Description: Verifiable Credential Contains UniqueId Mapping

  ParameterDocumentCheckResultTableName:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/DocumentCheckResultTableName"
      Value: !Sub document-check-${AWS::StackName}
      Type: String
      Description: Document check result dynamodb table name

  ParameterDvlaTokenTableName:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/DVLA/TokenTableName"
      Value: !Sub dvla-token-${AWS::StackName}
      Type: String
      Description: Dvla Token dynamodb table name

  MaxJwtTtlParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/MaxJwtTtl"
      Type: String
      Value: !FindInMap [MaxJwtTtlMapping, Environment, !Ref 'Environment']
      Description: default time to live for an JWT in (seconds)

  DrivingPermitCriAudienceParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/DrivingPermitCriAudience"
      Type: String
      Value: !FindInMap [DrivingPermitCriAudienceMapping, Environment, !Ref 'Environment']
      Description: The driving permit credential issuer (audience) identifier

  JwtTtlUnitParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/JwtTtlUnit"
      Type: String
      Value: !FindInMap [ JwtTtlUnitMapping, Environment, !Ref Environment ]
      Description: The unit for the time-to-live for an JWT e.g. (MONTHS)

  VerifiableCredentialKmsSigningKeyParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/verifiableCredentialKmsSigningKeyId"
      Type: String
      Value: !ImportValue core-infrastructure-CriVcSigningKey1Id
      Description: Verifiable Credential Key Id

  DVLAPasswordSecret:
    Type: 'AWS::SecretsManager::Secret'
    Properties:
      Name: !Sub "/${AWS::StackName}/DVLA/password"
      SecretString:
        !Sub
          - '{{resolve:ssm:/${PREFIX}/DVLA/password}}'
          - PREFIX: !If [ UseParameterPrefix, !Ref ParameterPrefix , !Ref AWS::StackName ]

      Description: This is a temp password used before the rotation function is applied. Checking if update triggers rotation

  LoggingKmsKey:
    Type: AWS::KMS::Key
    Properties:
      EnableKeyRotation: true
      KeyPolicy:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub "arn:aws:iam::${AWS::AccountId}:root"
            Action:
              - kms:*
            Resource: "*"
          - Effect: Allow
            Principal:
              Service: !Sub "logs.${AWS::Region}.amazonaws.com"
            Action:
              - "kms:Encrypt*"
              - "kms:Decrypt*"
              - "kms:ReEncrypt*"
              - "kms:GenerateDataKey*"
              - "kms:Describe*"
            Resource: "*"
            Condition:
              ArnLike:
                "kms:EncryptionContext:aws:logs:arn": !Sub "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:*"

####################################################################
#                                                                  #
# Alerts                                                           #
#                                                                  #
####################################################################

## Common API Alarms

  CommonAPISessionLambdaConcurrencyThresholdReached:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmDescription: !Sub Driving Licence ${Environment} - Common API Session Lambda concurrency threshold reached
      ActionsEnabled: true
      AlarmActions:
        - !Ref AlarmTopicDL
      OKActions:
        - !Ref AlarmTopicDL
      InsufficientDataActions: []
      MetricName: ConcurrentExecutions
      Namespace: AWS/Lambda
      Statistic: Average
      Dimensions:
        - Name: FunctionName
          Value: !Sub "${CommonStackName}-SessionFunction"
      Period: 60
      EvaluationPeriods: 15
      DatapointsToAlarm: 12
      Threshold: 3
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  CommonAPIAuthorizationLambdaConcurrencyThresholdReached:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmDescription: !Sub Driving Licence ${Environment} - Common API Authorization Lambda concurrency threshold reached
      ActionsEnabled: true
      AlarmActions:
        - !Ref AlarmTopicDL
      OKActions:
        - !Ref AlarmTopicDL
      InsufficientDataActions: []
      MetricName: ConcurrentExecutions
      Namespace: AWS/Lambda
      Statistic: Average
      Dimensions:
        - Name: FunctionName
          Value: !Sub "${CommonStackName}-AuthorizationFunction"
      Period: 60
      EvaluationPeriods: 15
      DatapointsToAlarm: 12
      Threshold: 3
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  CommonAPIAccessTokenLambdaConcurrencyThresholdReached:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmDescription: !Sub Driving Licence ${Environment} - Common API AccessToken Lambda concurrency threshold reached
      ActionsEnabled: true
      AlarmActions:
        - !Ref AlarmTopicDL
      OKActions:
        - !Ref AlarmTopicDL
      InsufficientDataActions: []
      MetricName: ConcurrentExecutions
      Namespace: AWS/Lambda
      Statistic: Average
      Dimensions:
        - Name: FunctionName
          Value: !Sub "${CommonStackName}-AccessTokenFunction"
      Period: 60
      EvaluationPeriods: 15
      DatapointsToAlarm: 12
      Threshold: 3
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  ## Driving Permit Alarms

  DLDrivingPermitCheckLambdaConcurrencyThresholdReached:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmDescription: !Sub Driving Licence ${Environment} - DrivingPermitCheck Lambda concurrency threshold reached
      ActionsEnabled: true
      AlarmActions:
        - !Ref AlarmTopicDL
      OKActions:
        - !Ref AlarmTopicDL
      InsufficientDataActions: []
      MetricName: ConcurrentExecutions
      Namespace: AWS/Lambda
      Statistic: Average
      Dimensions:
        - Name: FunctionName
          Value: !Ref DrivingPermitCheckingFunction
      Period: 60
      EvaluationPeriods: 15
      DatapointsToAlarm: 12
      Threshold: 3
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  DLIssueCredentialLambdaConcurrencyThresholdReached:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmDescription: !Sub Driving Licence ${Environment} - IssueCredential Lambda concurrency threshold reached
      ActionsEnabled: true
      AlarmActions:
        - !Ref AlarmTopicDL
      OKActions:
        - !Ref AlarmTopicDL
      InsufficientDataActions: []
      MetricName: ConcurrentExecutions
      Namespace: AWS/Lambda
      Statistic: Average
      Dimensions:
        - Name: FunctionName
          Value: !Ref IssueCredentialFunction
      Period: 60
      EvaluationPeriods: 15
      DatapointsToAlarm: 12
      Threshold: 3
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  DLLambdaErrors:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmDescription: !Sub Driving Licence ${Environment} lambda errors
      ActionsEnabled: true
      AlarmActions:
        - !Ref AlarmTopicDL
      OKActions:
        - !Ref AlarmTopicDL
      InsufficientDataActions: [ ]
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Dimensions: [ ]
      Period: 300
      DatapointsToAlarm: 3
      EvaluationPeriods: 3
      Threshold: 1
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching

  DLAPIGW5XXErrors:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmDescription: !Sub Driving Licence ${Environment} API Gateway 5XX errors
      ActionsEnabled: true
      AlarmActions:
        - !Ref AlarmTopicDL
      OKActions:
        - !Ref AlarmTopicDL
      InsufficientDataActions: [ ]
      Dimensions: [ ]
      DatapointsToAlarm: 3
      EvaluationPeriods: 3
      Threshold: 1
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching
      Metrics:
        - Id: e1
          Label: Expression1
          ReturnData: true
          Expression: SUM(METRICS())
        - Id: m1
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: 5XXError
              Dimensions:
                - Name: ApiName
                  Value: !Sub "${AWS::StackName}-PublicDLApi"
            Period: 300
            Stat: Sum
        - Id: m2
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: 5XXError
              Dimensions:
                - Name: ApiName
                  Value: !Sub "${AWS::StackName}-PrivateDLApi"
            Period: 300
            Stat: Sum

  DVLAAuthenticateTokenRequestDeniedAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${AWS::StackName}-${Environment} - Driving Licence - DVLA Authenticate Token Request Denied Alarm"
      AlarmDescription: !Sub Driving Licence ${Environment} DVLA Token endpoint returned a 400/401 response to a token request (failure to authenticate)
      ActionsEnabled: true
      AlarmActions:
        - !Ref AlarmTopicDL
      OKActions:
        - !Ref AlarmTopicDL
      InsufficientDataActions: []
      MetricName: dvla_third_party_api_token_endpoint_status_code_alert_metric
      Namespace: !Sub "${CriIdentifier}"
      Statistic: Sum
      Dimensions:
        - Name: Service
          Value: !Sub "${CriIdentifier}-drivingpermitcheck"
      Period: 60
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  CertificateExpiryAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${AWS::StackName}-${Environment} - Driving Licence - Certificate expiry Alarm"
      AlarmDescription: !Sub Driving Licence ${Environment} DVA certificate is close to expiry (expires within 28 days) see certificate catalogue in confluence for expiries and certificate names
      ActionsEnabled: true
      AlarmActions:
        - !Ref AlarmTopicDL
      OKActions:
        - !Ref AlarmTopicDL
      InsufficientDataActions: [ ]
      MetricName: dva_cert_expiry_metric
      Namespace: !Sub "${CriIdentifier}"
      Statistic: Sum
      Dimensions:
        - Name: Service
          Value: !Sub "${CriIdentifier}-CertExpiryReminder"
      Period: 60
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

####################################################################
#                                                                  #
# Alarm setup                                                      #
#                                                                  #
####################################################################

  AlarmTopicDL:
    Type: AWS::SNS::Topic
    Metadata:
      SamResourceId: AlarmTopicDL
  AlarmTopicSubscriptionPagerDutyDL:
    Type: AWS::SNS::Subscription
    Properties:
      TopicArn:
        Ref: AlarmTopicDL
      Endpoint:
        Fn::Sub: '{{resolve:ssm:/alerting/pagerduty-dl/url}}'
      Protocol: https
    Metadata:
      SamResourceId: AlarmTopicSubscriptionPagerDutyDL
  AlarmPublishToTopicPolicyDL:
    Type: AWS::SNS::TopicPolicy
    Properties:
      Topics:
        - Ref: AlarmTopicDL
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action: sns:Publish
            Resource:
              Ref: AlarmTopicDL
            Principal:
              Service: cloudwatch.amazonaws.com
            Condition:
              ArnLike:
                AWS:SourceArn:
                  Fn::Sub: arn:aws:cloudwatch:${AWS::Region}:${AWS::AccountId}:alarm:*
    Metadata:
      SamResourceId: AlarmPublishToTopicPolicyDL

  ####################################################################
  #                                                                  #
  # Monitoring & Alerts                                              #
  #                                                                  #
  ####################################################################

  5XXErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: "DeployAlarms"
    Properties:
      AlarmName: !Sub "${AWS::StackName}-5XXErrorAlarm"
      AlarmDescription: !Sub "There has been a small proportion of 5XX errors on the backend api-gateway. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-warning-alert-topic
      AlarmActions:
        - !ImportValue platform-alarm-warning-alert-topic
      InsufficientDataActions: [ ]
      Dimensions: [ ]
      EvaluationPeriods: 5
      DatapointsToAlarm: 2
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
      Metrics:
        - Id: errorThreshold
          Label: errorThreshold
          ReturnData: true
          Expression: IF(invocations<10,0,errorPercentage)
        - Id: invocations
          ReturnData: false
          Expression: invocationspriv + invocationspub
        - Id: invocationspriv
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: Count
              Dimensions:
                - Name: ApiName
                  Value: !Sub "${AWS::StackName}-PrivateDLApi"
            Period: 60
            Stat: Sum
        - Id: invocationspub
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: Count
              Dimensions:
                - Name: ApiName
                  Value: !Sub "${AWS::StackName}-PublicDLApi"
            Period: 60
            Stat: Sum
        - Id: error
          ReturnData: false
          Expression: errorpriv + errorpub
        - Id: errorPercentage
          Label: errorPercentage
          ReturnData: false
          Expression: (error/invocations)*100
        - Id: errorpriv
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: 5XXError
              Dimensions:
                - Name: ApiName
                  Value: !Sub "${AWS::StackName}-PrivateDLApi"
            Period: 60
            Stat: Sum
        - Id: errorpub
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: 5XXError
              Dimensions:
                - Name: ApiName
                  Value: !Sub "${AWS::StackName}-PublicDLApi"
            Period: 60
            Stat: Sum

  5XXErrorCriticalAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: "DeployAlarms"
    Properties:
      AlarmName: !Sub "${AWS::StackName}-5XXErrorCriticalAlarm"
      AlarmDescription: !Sub "There has been a significant proportion of 5XX errors on the backend api-gateway. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-critical-alert-topic
      AlarmActions:
        - !ImportValue platform-alarm-critical-alert-topic
      InsufficientDataActions: [ ]
      Dimensions: [ ]
      EvaluationPeriods: 5
      DatapointsToAlarm: 2
      Threshold: 80
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
      Metrics:
        - Id: errorThreshold
          Label: errorThreshold
          ReturnData: true
          Expression: IF(invocations<10,0,errorPercentage)
        - Id: invocations
          ReturnData: false
          Expression: invocationspriv + invocationspub
        - Id: invocationspriv
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: Count
              Dimensions:
                - Name: ApiName
                  Value: !Sub "${AWS::StackName}-PrivateDLApi"
            Period: 60
            Stat: Sum
        - Id: invocationspub
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: Count
              Dimensions:
                - Name: ApiName
                  Value: !Sub "${AWS::StackName}-PublicDLApi"
            Period: 60
            Stat: Sum
        - Id: error
          ReturnData: false
          Expression: errorpriv + errorpub
        - Id: errorPercentage
          Label: errorPercentage
          ReturnData: false
          Expression: (error/invocations)*100
        - Id: errorpriv
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: 5XXError
              Dimensions:
                - Name: ApiName
                  Value: !Sub "${AWS::StackName}-PrivateDLApi"
            Period: 60
            Stat: Sum
        - Id: errorpub
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: 5XXError
              Dimensions:
                - Name: ApiName
                  Value: !Sub "${AWS::StackName}-PublicDLApi"
            Period: 60
            Stat: Sum

  LatencyAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: "DeployAlarms"
    Properties:
      AlarmName: !Sub "${AWS::StackName}-apiGWLatencyAlarm"
      AlarmDescription: !Sub "There has been increased latency on backend api-gateway. ${SupportManualURL}"
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-warning-alert-topic
      OKActions:
        - !ImportValue platform-alarm-warning-alert-topic
      InsufficientDataActions: [ ]
      Dimensions: [ ]
      EvaluationPeriods: 5
      DatapointsToAlarm: 2
      Threshold: 2500
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
      Metrics:
        - Id: safeLatency
          Label: safeLatency
          ReturnData: true
          Expression: IF(invocations<10,0,maxLatency)
        - Id: invocations
          ReturnData: false
          Expression: invocationspriv + invocationspub
        - Id: maxLatency
          ReturnData: false
          Expression: MAX([maxLatencypriv, maxLatencypub])
        - Id: invocationspriv
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: Count
              Dimensions:
                - Name: ApiName
                  Value: !Sub "${AWS::StackName}-PrivateDLApi"
            Period: 60
            Stat: Sum
        - Id: invocationspub
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: Count
              Dimensions:
                - Name: ApiName
                  Value: !Sub "${AWS::StackName}-PublicDLApi"
            Period: 60
            Stat: Sum
        - Id: maxLatencypriv
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: Latency
              Dimensions:
                - Name: ApiName
                  Value: !Sub "${AWS::StackName}-PrivateDLApi"
            Period: 60
            Stat: Maximum
        - Id: maxLatencypub
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: Latency
              Dimensions:
                - Name: ApiName
                  Value: !Sub "${AWS::StackName}-PublicDLApi"
            Period: 60
            Stat: Maximum

  PublicDrivingPermitApiAccessLogGroupFatalErrorMetricFilter:
    Type: AWS::Logs::MetricFilter
    Condition: "DeployAlarms"
    Properties:
      LogGroupName: !Ref PublicDrivingPermitApiAccessLogGroup
      FilterPattern: '{ $.level = "FATAL" || $.message = "Unhandled Exception:*" }'
      MetricTransformations:
        - MetricValue: "1"
          MetricNamespace: !Sub "${AWS::StackName}/LogMessages"
          MetricName: "PublicDrivingPermitApi-Fatalerror"

  PublicDrivingPermitAPIGatewayFatalErrorAlarm:
    DependsOn:
      - "PublicDrivingPermitApiAccessLogGroupFatalErrorMetricFilter"
    Type: AWS::CloudWatch::Alarm
    Condition: "DeployAlarms"
    Properties:
      AlarmName: !Sub "${AWS::StackName}-PublicDrivingPermitApi-FatalErrorAlarm"
      AlarmDescription: !Sub "Trigger an alarm when Fatal Error occurs in Public Driving Permit API. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-warning-alert-topic
      AlarmActions:
        - !ImportValue platform-alarm-warning-alert-topic
      InsufficientDataActions: [ ]
      MetricName: PublicDrivingPermitApi-Fatalerror
      Namespace: !Sub "${AWS::StackName}/LogMessages"
      Statistic: Sum
      Dimensions: [ ]
      Period: 60
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  PrivateDrivingPermitApiAccessLogGroupFatalErrorMetricFilter:
    Type: AWS::Logs::MetricFilter
    Condition: "DeployAlarms"
    Properties:
      LogGroupName: !Ref PrivateDrivingPermitApiAccessLogGroup
      FilterPattern: '{ $.level = "FATAL" || $.message = "Unhandled Exception:*" }'
      MetricTransformations:
        - MetricValue: "1"
          MetricNamespace: !Sub "${AWS::StackName}/LogMessages"
          MetricName: "PrivateDrivingPermitApi-Fatalerror"

  PrivateDrivingPermitAPIGatewayFatalErrorAlarm:
    DependsOn:
      - "PrivateDrivingPermitApiAccessLogGroupFatalErrorMetricFilter"
    Type: AWS::CloudWatch::Alarm
    Condition: "DeployAlarms"
    Properties:
      AlarmName: !Sub "${AWS::StackName}-PrivateDrivingPermitApi-FatalErrorAlarm"
      AlarmDescription: !Sub "Trigger an alarm when Fatal Error occurs in Private Driving Permit API. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-warning-alert-topic
      AlarmActions:
        - !ImportValue platform-alarm-warning-alert-topic
      InsufficientDataActions: [ ]
      MetricName: PrivateDrivingPermitApi-Fatalerror
      Namespace: !Sub "${AWS::StackName}/LogMessages"
      Statistic: Sum
      Dimensions: [ ]
      Period: 60
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
################################# Common Lambda Authorization Alarms ##############################
  Authorization5XXApiGwErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-Authorization5XXApiGwErrorAlarm"
      AlarmDescription: !Sub "There has been a small proportion of 5XX errors on the Authorization endpoint. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-warning-alert-topic
      AlarmActions:
        - !ImportValue platform-alarm-warning-alert-topic
      InsufficientDataActions: [ ]
      Dimensions: [ ]
      EvaluationPeriods: 5
      DatapointsToAlarm: 2
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
      Metrics:
        - Id: errorThreshold
          Label: errorThreshold
          ReturnData: true
          Expression: IF(invocations<4 || error<2,0,errorPercentage)
        - Id: invocations
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: Count
              Dimensions:
                - Name: Method
                  Value: GET
                - Name: ApiName
                  Value: !Sub "${AWS::StackName}-PrivateDLApi"
                - Name: Stage
                  Value: !Ref Environment
                - Name: Resource
                  Value: /authorization
            Period: 60
            Stat: Sum
        - Id: errorPercentage
          Label: errorPercentage
          ReturnData: false
          Expression: (error/invocations)*100
        - Id: error
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: 5XXError
              Dimensions:
                - Name: Method
                  Value: GET
                - Name: ApiName
                  Value: !Sub "${AWS::StackName}-PrivateDLApi"
                - Name: Stage
                  Value: !Ref Environment
                - Name: Resource
                  Value: /authorization
            Period: 60
            Stat: Sum

  Authorization5XXApiGwErrorCriticalAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-Authorization5XXApiGwErrorCriticalAlarm"
      AlarmDescription: !Sub "There has been a significant proportion of 5XX errors on the Authorization endpoint. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-critical-alert-topic
      AlarmActions:
        - !ImportValue platform-alarm-critical-alert-topic
      InsufficientDataActions: [ ]
      Dimensions: [ ]
      EvaluationPeriods: 5
      DatapointsToAlarm: 2
      Threshold: 80
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
      Metrics:
        - Id: errorThreshold
          Label: errorThreshold
          ReturnData: true
          Expression: IF(invocations<10,0,errorPercentage)
        - Id: invocations
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: Count
              Dimensions:
                - Name: Method
                  Value: GET
                - Name: ApiName
                  Value: !Sub "${AWS::StackName}-PrivateDLApi"
                - Name: Stage
                  Value: !Ref Environment
                - Name: Resource
                  Value: /authorization
            Period: 60
            Stat: Sum
        - Id: errorPercentage
          Label: errorPercentage
          ReturnData: false
          Expression: (error/invocations)*100
        - Id: error
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: 5XXError
              Dimensions:
                - Name: Method
                  Value: GET
                - Name: ApiName
                  Value: !Sub "${AWS::StackName}-PrivateDLApi"
                - Name: Stage
                  Value: !Ref Environment
                - Name: Resource
                  Value: /authorization
            Period: 60
            Stat: Sum

  Authorization4XXApiGwErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-Authorization4XXApiGwErrorAlarm"
      AlarmDescription: !Sub "There has been a small proportion of 4XX errors on the Authorization endpoint. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-warning-alert-topic
      AlarmActions:
        - !ImportValue platform-alarm-warning-alert-topic
      InsufficientDataActions: [ ]
      Dimensions: [ ]
      EvaluationPeriods: 5
      DatapointsToAlarm: 2
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
      Metrics:
        - Id: errorThreshold
          Label: errorThreshold
          ReturnData: true
          Expression: IF(invocations<2 || error<2,0,errorPercentage)
        - Id: invocations
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: Count
              Dimensions:
                - Name: ApiName
                  Value: !Sub "${AWS::StackName}-PrivateDLApi"
                - Name: Resource
                  Value: /authorization
                - Name: Stage
                  Value: !Ref Environment
                - Name: Method
                  Value: GET
            Period: 60
            Stat: Sum
        - Id: errorPercentage
          Label: errorPercentage
          ReturnData: false
          Expression: (error/invocations)*100
        - Id: error
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: 4XXError
              Dimensions:
                - Name: ApiName
                  Value: !Sub "${AWS::StackName}-PrivateDLApi"
                - Name: Resource
                  Value: /authorization
                - Name: Stage
                  Value: !Ref Environment
                - Name: Method
                  Value: GET
            Period: 60
            Stat: Sum

  AuthorizationThrottleAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: "DeployAlarms"
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-critical-alert-topic
      OKActions:
        - !ImportValue platform-alarm-critical-alert-topic
      InsufficientDataActions: []
      AlarmDescription: !Sub "Trigger if the ${CommonStackName}-AuthorizationFunction lambda throttles. ${SupportManualURL}"
      AlarmName: !Sub "${AWS::StackName}-AuthorizationFunction-throttles"
      MetricName: Throttles
      Namespace: AWS/Lambda
      Statistic: Sum
      Dimensions:
        - Name: FunctionName
          Value: !Sub "${CommonStackName}-AuthorizationFunction"
      TreatMissingData: notBreaching
      Period: 60 # This is the minimum value for the AWS Namespace
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold

  AuthorizationFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/apigateway/${AWS::StackName}-AuthorizationFunction
      RetentionInDays: !Ref LogGroupRetentionInDays

  AuthorizationFunctionLogGroupSubscriptionFilterCsls:
    Type: AWS::Logs::SubscriptionFilter
    Condition: LogSendingEnabled
    Properties:
      DestinationArn: "arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython"
      FilterPattern: ""
      LogGroupName: !Ref AuthorizationFunctionLogGroup

  AuthorizationFunctionFatalErorMetricFilter:
    Type: AWS::Logs::MetricFilter
    Condition: "DeployAlarms"
    Properties:
      LogGroupName: !Ref AuthorizationFunctionLogGroup
      FilterPattern: '{ $.level = "FATAL" || $.message = "Unhandled Exception:*" }'
      MetricTransformations:
        -
          MetricValue: "1"
          MetricNamespace: !Sub "${AWS::StackName}/LogMessages"
          MetricName: "AuthorizationFunction-Fatalerror"

  AuthorizationFunctionFatalErrorAlarm:
    DependsOn:
      - "AuthorizationFunctionFatalErorMetricFilter"
    Type: AWS::CloudWatch::Alarm
    Condition: "DeployAlarms"
    Properties:
      AlarmName: !Sub "${AWS::StackName}-AuthorizationFunction-FatalErrorAlarm"
      AlarmDescription: !Sub "Trigger an alarm when Fatal Error occurs. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-warning-alert-topic
      AlarmActions:
        - !ImportValue platform-alarm-warning-alert-topic
      InsufficientDataActions: [ ]
      MetricName: AuthorizationFunction-Fatalerror
      Namespace: !Sub "${AWS::StackName}/LogMessages"
      Statistic: Sum
      Dimensions: [ ]
      Period: 60
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

################################# CommonLambda AccessTokenFunction Alarms ##############################


  AccessToken5XXApiGwErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-AccessToken5XXApiGwErrorAlarm"
      AlarmDescription: !Sub "There has been a small proportion of 5XX errors on the AccessToken endpoint. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-warning-alert-topic
      AlarmActions:
        - !ImportValue platform-alarm-warning-alert-topic
      InsufficientDataActions: [ ]
      Dimensions: [ ]
      EvaluationPeriods: 5
      DatapointsToAlarm: 2
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
      Metrics:
        - Id: errorThreshold
          Label: errorThreshold
          ReturnData: true
          Expression: IF(invocations<4 || error<2,0,errorPercentage)
        - Id: invocations
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: Count
              Dimensions:
                - Name: Method
                  Value: POST
                - Name: ApiName
                  Value: !Sub "${AWS::StackName}-PublicDLApi"
                - Name: Stage
                  Value: !Ref Environment
                - Name: Resource
                  Value: /token
            Period: 60
            Stat: Sum
        - Id: errorPercentage
          Label: errorPercentage
          ReturnData: false
          Expression: (error/invocations)*100
        - Id: error
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: 5XXError
              Dimensions:
                - Name: Method
                  Value: POST
                - Name: ApiName
                  Value: !Sub "${AWS::StackName}-PublicDLApi"
                - Name: Stage
                  Value: !Ref Environment
                - Name: Resource
                  Value: /token
            Period: 60
            Stat: Sum

  AccessToken5XXApiGwErrorCriticalAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-AccessToken5XXApiGwErrorCriticalAlarm"
      AlarmDescription: !Sub "There has been a significant proportion of 5XX errors on the AccessToken endpoint. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-critical-alert-topic
      AlarmActions:
        - !ImportValue platform-alarm-critical-alert-topic
      InsufficientDataActions: [ ]
      Dimensions: [ ]
      EvaluationPeriods: 5
      DatapointsToAlarm: 2
      Threshold: 80
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
      Metrics:
        - Id: errorThreshold
          Label: errorThreshold
          ReturnData: true
          Expression: IF(invocations<10,0,errorPercentage)
        - Id: invocations
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: Count
              Dimensions:
                - Name: Method
                  Value: POST
                - Name: ApiName
                  Value: !Sub "${AWS::StackName}-PublicDLApi"
                - Name: Stage
                  Value: !Ref Environment
                - Name: Resource
                  Value: /token
            Period: 60
            Stat: Sum
        - Id: errorPercentage
          Label: errorPercentage
          ReturnData: false
          Expression: (error/invocations)*100
        - Id: error
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: 5XXError
              Dimensions:
                - Name: Method
                  Value: POST
                - Name: ApiName
                  Value: !Sub "${AWS::StackName}-PublicDLApi"
                - Name: Stage
                  Value: !Ref Environment
                - Name: Resource
                  Value: /token
            Period: 60
            Stat: Sum

  AccessToken4XXApiGwErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-AccessToken4XXApiGwErrorAlarm"
      AlarmDescription: !Sub "There has been a small proportion of 4XX errors on the AccessToken endpoint. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-warning-alert-topic
      AlarmActions:
        - !ImportValue platform-alarm-warning-alert-topic
      InsufficientDataActions: [ ]
      Dimensions: [ ]
      EvaluationPeriods: 5
      DatapointsToAlarm: 2
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
      Metrics:
        - Id: errorThreshold
          Label: errorThreshold
          ReturnData: true
          Expression: IF(invocations<2 || error<2,0,errorPercentage)
        - Id: invocations
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: Count
              Dimensions:
                - Name: ApiName
                  Value: !Sub "${AWS::StackName}-PublicDLApi"
                - Name: Resource
                  Value: /token
                - Name: Stage
                  Value: !Ref Environment
                - Name: Method
                  Value: POST
            Period: 60
            Stat: Sum
        - Id: errorPercentage
          Label: errorPercentage
          ReturnData: false
          Expression: (error/invocations)*100
        - Id: error
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: 4XXError
              Dimensions:
                - Name: ApiName
                  Value: !Sub "${AWS::StackName}-PublicDLApi"
                - Name: Resource
                  Value: /token
                - Name: Stage
                  Value: !Ref Environment
                - Name: Method
                  Value: POST
            Period: 60
            Stat: Sum

  AccessTokenThrottleAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: "DeployAlarms"
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-critical-alert-topic
      OKActions:
        - !ImportValue platform-alarm-critical-alert-topic
      InsufficientDataActions: []
      AlarmDescription: !Sub "Trigger if the ${CommonStackName}-AccessTokenFunction lambda throttles. ${SupportManualURL}"
      AlarmName: !Sub "${AWS::StackName}-AccessTokenFunction-throttles"
      MetricName: Throttles
      Namespace: AWS/Lambda
      Statistic: Sum
      Dimensions:
        - Name: FunctionName
          Value: !Sub "${CommonStackName}-AccessTokenFunction"
      TreatMissingData: notBreaching
      Period: 60 # This is the minimum value for the AWS Namespace
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold

  AccessTokenFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/apigateway/${AWS::StackName}-AccessTokenFunction
      RetentionInDays: !Ref LogGroupRetentionInDays

  AccessTokenFunctionLogGroupSubscriptionFilterCsls:
    Type: AWS::Logs::SubscriptionFilter
    Condition: LogSendingEnabled
    Properties:
      DestinationArn: "arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython"
      FilterPattern: ""
      LogGroupName: !Ref AccessTokenFunctionLogGroup

  AccessTokenFunctionFatalErorMetricFilter:
    Type: AWS::Logs::MetricFilter
    Condition: "DeployAlarms"
    Properties:
      LogGroupName: !Ref AccessTokenFunctionLogGroup
      FilterPattern: '{ $.level = "FATAL" || $.message = "Unhandled Exception:*" }'
      MetricTransformations:
        -
          MetricValue: "1"
          MetricNamespace: !Sub "${AWS::StackName}/LogMessages"
          MetricName: "AccessTokenFunction-Fatalerror"

  AccessTokenFunctionFatalErrorAlarm:
    DependsOn:
      - "AccessTokenFunctionFatalErorMetricFilter"
    Type: AWS::CloudWatch::Alarm
    Condition: "DeployAlarms"
    Properties:
      AlarmName: !Sub "${AWS::StackName}-AccessTokenFunction-FatalErrorAlarm"
      AlarmDescription: !Sub "Trigger an alarm when Fatal Error occurs. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-warning-alert-topic
      AlarmActions:
        - !ImportValue platform-alarm-warning-alert-topic
      InsufficientDataActions: [ ]
      MetricName: AccessTokenFunction-Fatalerror
      Namespace: !Sub "${AWS::StackName}/LogMessages"
      Statistic: Sum
      Dimensions: [ ]
      Period: 60
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

################################# Common Lambda Session Alarms ##############################
  Session5XXApiGwErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-Session5XXApiGwErrorAlarm"
      AlarmDescription: !Sub "There has been a small proportion of 5XX errors on the Session endpoint. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-warning-alert-topic
      AlarmActions:
        - !ImportValue platform-alarm-warning-alert-topic
      InsufficientDataActions: [ ]
      Dimensions: [ ]
      EvaluationPeriods: 5
      DatapointsToAlarm: 2
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
      Metrics:
        - Id: errorThreshold
          Label: errorThreshold
          ReturnData: true
          Expression: IF(invocations<4 || error<2,0,errorPercentage)
        - Id: invocations
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: Count
              Dimensions:
                - Name: Method
                  Value: POST
                - Name: ApiName
                  Value: !Sub "${AWS::StackName}-PrivateDLApi"
                - Name: Stage
                  Value: !Ref Environment
                - Name: Resource
                  Value: /session
            Period: 60
            Stat: Sum
        - Id: errorPercentage
          Label: errorPercentage
          ReturnData: false
          Expression: (error/invocations)*100
        - Id: error
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: 5XXError
              Dimensions:
                - Name: Method
                  Value: POST
                - Name: ApiName
                  Value: !Sub "${AWS::StackName}-PrivateDLApi"
                - Name: Stage
                  Value: !Ref Environment
                - Name: Resource
                  Value: /session
            Period: 60
            Stat: Sum

  Session5XXApiGwErrorCriticalAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-Session5XXApiGwErrorCriticalAlarm"
      AlarmDescription: !Sub "There has been a significant proportion of 5XX errors on the Session endpoint. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-critical-alert-topic
      AlarmActions:
        - !ImportValue platform-alarm-critical-alert-topic
      InsufficientDataActions: [ ]
      Dimensions: [ ]
      EvaluationPeriods: 5
      DatapointsToAlarm: 2
      Threshold: 80
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
      Metrics:
        - Id: errorThreshold
          Label: errorThreshold
          ReturnData: true
          Expression: IF(invocations<10,0,errorPercentage)
        - Id: invocations
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: Count
              Dimensions:
                - Name: Method
                  Value: POST
                - Name: ApiName
                  Value: !Sub "${AWS::StackName}-PrivateDLApi"
                - Name: Stage
                  Value: !Ref Environment
                - Name: Resource
                  Value: /session
            Period: 60
            Stat: Sum
        - Id: errorPercentage
          Label: errorPercentage
          ReturnData: false
          Expression: (error/invocations)*100
        - Id: error
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: 5XXError
              Dimensions:
                - Name: Method
                  Value: POST
                - Name: ApiName
                  Value: !Sub "${AWS::StackName}-PrivateDLApi"
                - Name: Stage
                  Value: !Ref Environment
                - Name: Resource
                  Value: /session
            Period: 60
            Stat: Sum

  Session4XXApiGwErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-Session4XXApiGwErrorAlarm"
      AlarmDescription: !Sub "There has been a small proportion of 4XX errors on the Session endpoint. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-warning-alert-topic
      AlarmActions:
        - !ImportValue platform-alarm-warning-alert-topic
      InsufficientDataActions: [ ]
      Dimensions: [ ]
      EvaluationPeriods: 5
      DatapointsToAlarm: 2
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
      Metrics:
        - Id: errorThreshold
          Label: errorThreshold
          ReturnData: true
          Expression: IF(invocations<2 || error<2,0,errorPercentage)
        - Id: invocations
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: Count
              Dimensions:
                - Name: ApiName
                  Value: !Sub "${AWS::StackName}-PrivateDLApi"
                - Name: Resource
                  Value: /session
                - Name: Stage
                  Value: !Ref Environment
                - Name: Method
                  Value: POST
            Period: 60
            Stat: Sum
        - Id: errorPercentage
          Label: errorPercentage
          ReturnData: false
          Expression: (error/invocations)*100
        - Id: error
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: 4XXError
              Dimensions:
                - Name: ApiName
                  Value: !Sub "${AWS::StackName}-PrivateDLApi"
                - Name: Resource
                  Value: /session
                - Name: Stage
                  Value: !Ref Environment
                - Name: Method
                  Value: POST
            Period: 60
            Stat: Sum

  SessionThrottleAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: "DeployAlarms"
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-critical-alert-topic
      OKActions:
        - !ImportValue platform-alarm-critical-alert-topic
      InsufficientDataActions: []
      AlarmDescription: !Sub "Trigger if the ${CommonStackName}-SessionFunction lambda throttles. ${SupportManualURL}"
      AlarmName: !Sub "${AWS::StackName}-SessionFunction-throttles"
      MetricName: Throttles
      Namespace: AWS/Lambda
      Statistic: Sum
      Dimensions:
        - Name: FunctionName
          Value: !Sub "${CommonStackName}-SessionFunction"
      TreatMissingData: notBreaching
      Period: 60 # This is the minimum value for the AWS Namespace
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold

  SessionFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/apigateway/${AWS::StackName}-SessionFunction
      RetentionInDays: !Ref LogGroupRetentionInDays

  SessionFunctionLogGroupSubscriptionFilterCsls:
    Type: AWS::Logs::SubscriptionFilter
    Condition: LogSendingEnabled
    Properties:
      DestinationArn: "arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython"
      FilterPattern: ""
      LogGroupName: !Ref SessionFunctionLogGroup

  SessionFunctionFatalErorMetricFilter:
    Type: AWS::Logs::MetricFilter
    Condition: "DeployAlarms"
    Properties:
      LogGroupName: !Ref SessionFunctionLogGroup
      FilterPattern: '{ $.level = "FATAL" || $.message = "Unhandled Exception:*" }'
      MetricTransformations:
        -
          MetricValue: "1"
          MetricNamespace: !Sub "${AWS::StackName}/LogMessages"
          MetricName: "SessionFunction-Fatalerror"

  SessionFunctionFatalErrorAlarm:
    DependsOn:
      - "SessionFunctionFatalErorMetricFilter"
    Type: AWS::CloudWatch::Alarm
    Condition: "DeployAlarms"
    Properties:
      AlarmName: !Sub "${AWS::StackName}-SessionFunction-FatalErrorAlarm"
      AlarmDescription: !Sub "Trigger an alarm when Fatal Error occurs. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-warning-alert-topic
      AlarmActions:
        - !ImportValue platform-alarm-warning-alert-topic
      InsufficientDataActions: [ ]
      MetricName: SessionFunction-Fatalerror
      Namespace: !Sub "${AWS::StackName}/LogMessages"
      Statistic: Sum
      Dimensions: [ ]
      Period: 60
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

################################# DrivingPermitChecking Alarms ##############################
  DrivingPermitChecking5XXApiGwErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-DrivingPermitChecking5XXApiGwErrorAlarm"
      AlarmDescription: !Sub "There has been a small proportion of 5XX errors on the DrivingPermitChecking endpoint. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-warning-alert-topic
      AlarmActions:
        - !ImportValue platform-alarm-warning-alert-topic
      InsufficientDataActions: [ ]
      Dimensions: [ ]
      EvaluationPeriods: 5
      DatapointsToAlarm: 2
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
      Metrics:
        - Id: errorThreshold
          Label: errorThreshold
          ReturnData: true
          Expression: IF(invocations<4 || error<2,0,errorPercentage)
        - Id: invocations
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: Count
              Dimensions:
                - Name: Method
                  Value: POST
                - Name: ApiName
                  Value: !Sub "${AWS::StackName}-PrivateDLApi"
                - Name: Stage
                  Value: !Ref Environment
                - Name: Resource
                  Value: /check-driving-licence
            Period: 60
            Stat: Sum
        - Id: errorPercentage
          Label: errorPercentage
          ReturnData: false
          Expression: (error/invocations)*100
        - Id: error
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: 5XXError
              Dimensions:
                - Name: Method
                  Value: POST
                - Name: ApiName
                  Value: !Sub "${AWS::StackName}-PrivateDLApi"
                - Name: Stage
                  Value: !Ref Environment
                - Name: Resource
                  Value: /check-driving-licence
            Period: 60
            Stat: Sum

  DrivingPermitChecking5XXApiGwErrorCriticalAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-DrivingPermitChecking5XXApiGwErrorCriticalAlarm"
      AlarmDescription: !Sub "There has been a significant proportion of 5XX errors on the DrivingPermitChecking endpoint. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-critical-alert-topic
      AlarmActions:
        - !ImportValue platform-alarm-critical-alert-topic
      InsufficientDataActions: [ ]
      Dimensions: [ ]
      EvaluationPeriods: 5
      DatapointsToAlarm: 2
      Threshold: 80
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
      Metrics:
        - Id: errorThreshold
          Label: errorThreshold
          ReturnData: true
          Expression: IF(invocations<10,0,errorPercentage)
        - Id: invocations
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: Count
              Dimensions:
                - Name: Method
                  Value: POST
                - Name: ApiName
                  Value: !Sub "${AWS::StackName}-PrivateDLApi"
                - Name: Stage
                  Value: !Ref Environment
                - Name: Resource
                  Value: /check-driving-licence
            Period: 60
            Stat: Sum
        - Id: errorPercentage
          Label: errorPercentage
          ReturnData: false
          Expression: (error/invocations)*100
        - Id: error
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: 5XXError
              Dimensions:
                - Name: Method
                  Value: POST
                - Name: ApiName
                  Value: !Sub "${AWS::StackName}-PrivateDLApi"
                - Name: Stage
                  Value: !Ref Environment
                - Name: Resource
                  Value: /check-driving-licence
            Period: 60
            Stat: Sum

  DrivingPermitChecking4XXApiGwErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-DrivingPermitChecking4XXApiGwErrorAlarm"
      AlarmDescription: !Sub "There has been a small proportion of 4XX errors on the DrivingPermitChecking endpoint. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-warning-alert-topic
      AlarmActions:
        - !ImportValue platform-alarm-warning-alert-topic
      InsufficientDataActions: [ ]
      Dimensions: [ ]
      EvaluationPeriods: 5
      DatapointsToAlarm: 2
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
      Metrics:
        - Id: errorThreshold
          Label: errorThreshold
          ReturnData: true
          Expression: IF(invocations<2 || error<2,0,errorPercentage)
        - Id: invocations
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: Count
              Dimensions:
                - Name: ApiName
                  Value: !Sub "${AWS::StackName}-PrivateDLApi"
                - Name: Resource
                  Value: /check-driving-licence
                - Name: Stage
                  Value: !Ref Environment
                - Name: Method
                  Value: POST
            Period: 60
            Stat: Sum
        - Id: errorPercentage
          Label: errorPercentage
          ReturnData: false
          Expression: (error/invocations)*100
        - Id: error
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: 4XXError
              Dimensions:
                - Name: ApiName
                  Value: !Sub "${AWS::StackName}-PrivateDLApi"
                - Name: Resource
                  Value: /check-driving-licence
                - Name: Stage
                  Value: !Ref Environment
                - Name: Method
                  Value: POST
            Period: 60
            Stat: Sum

  DrivingPermitCheckingThrottleAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: "DeployAlarms"
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-critical-alert-topic
      OKActions:
        - !ImportValue platform-alarm-critical-alert-topic
      InsufficientDataActions: []
      AlarmDescription: !Sub "Trigger if the ${DrivingPermitCheckingFunction} lambda throttles. ${SupportManualURL}"
      AlarmName: !Sub "${AWS::StackName}-DrivingPermitCheckingFunction-throttles"
      MetricName: Throttles
      Namespace: AWS/Lambda
      Statistic: Sum
      Dimensions:
        - Name: FunctionName
          Value: !Ref DrivingPermitCheckingFunction
      TreatMissingData: notBreaching
      Period: 60 # This is the minimum value for the AWS Namespace
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold

  DrivingPermitCheckingFunctionFatalErorMetricFilter:
    Type: AWS::Logs::MetricFilter
    Condition: "DeployAlarms"
    Properties:
      LogGroupName: !Ref DrivingPermitCheckingFunctionLogGroup
      FilterPattern: '{ $.level = "FATAL" || $.message = "Unhandled Exception:*" }'
      MetricTransformations:
        -
          MetricValue: "1"
          MetricNamespace: !Sub "${AWS::StackName}/LogMessages"
          MetricName: "DrivingPermitCheckingFunction-Fatalerror"

  DrivingPermitCheckingFunctionFatalErrorAlarm:
    DependsOn:
      - "DrivingPermitCheckingFunctionFatalErorMetricFilter"
    Type: AWS::CloudWatch::Alarm
    Condition: "DeployAlarms"
    Properties:
      AlarmName: !Sub "${AWS::StackName}-DrivingPermitCheckingFunction-FatalErrorAlarm"
      AlarmDescription: !Sub "Trigger an alarm when Fatal Error occurs. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-warning-alert-topic
      AlarmActions:
        - !ImportValue platform-alarm-warning-alert-topic
      InsufficientDataActions: [ ]
      MetricName: DrivingPermitCheckingFunction-Fatalerror
      Namespace: !Sub "${AWS::StackName}/LogMessages"
      Statistic: Sum
      Dimensions: [ ]
      Period: 60
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
################################# IssueCredential Alarms ##############################
  IssueCredential5XXApiGwErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-IssueCredential5XXApiGwErrorAlarm"
      AlarmDescription: !Sub "There has been a small proportion of 5XX errors on the IssueCredential endpoint. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-warning-alert-topic
      AlarmActions:
        - !ImportValue platform-alarm-warning-alert-topic
      InsufficientDataActions: [ ]
      Dimensions: [ ]
      EvaluationPeriods: 5
      DatapointsToAlarm: 2
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
      Metrics:
        - Id: errorThreshold
          Label: errorThreshold
          ReturnData: true
          Expression: IF(invocations<4 || error<2,0,errorPercentage)
        - Id: invocations
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: Count
              Dimensions:
                - Name: Method
                  Value: POST
                - Name: ApiName
                  Value: !Sub "${AWS::StackName}-PublicDLApi"
                - Name: Stage
                  Value: !Ref Environment
                - Name: Resource
                  Value: /credential/issue
            Period: 60
            Stat: Sum
        - Id: errorPercentage
          Label: errorPercentage
          ReturnData: false
          Expression: (error/invocations)*100
        - Id: error
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: 5XXError
              Dimensions:
                - Name: Method
                  Value: POST
                - Name: ApiName
                  Value: !Sub "${AWS::StackName}-PublicDLApi"
                - Name: Stage
                  Value: !Ref Environment
                - Name: Resource
                  Value: /credential/issue
            Period: 60
            Stat: Sum

  IssueCredential5XXApiGwErrorCriticalAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-IssueCredential5XXApiGwErrorCriticalAlarm"
      AlarmDescription: !Sub "There has been a significant proportion of 5XX errors on the IssueCredential endpoint. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-critical-alert-topic
      AlarmActions:
        - !ImportValue platform-alarm-critical-alert-topic
      InsufficientDataActions: [ ]
      Dimensions: [ ]
      EvaluationPeriods: 5
      DatapointsToAlarm: 2
      Threshold: 80
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
      Metrics:
        - Id: errorThreshold
          Label: errorThreshold
          ReturnData: true
          Expression: IF(invocations<10,0,errorPercentage)
        - Id: invocations
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: Count
              Dimensions:
                - Name: Method
                  Value: POST
                - Name: ApiName
                  Value: !Sub "${AWS::StackName}-PublicDLApi"
                - Name: Stage
                  Value: !Ref Environment
                - Name: Resource
                  Value: /credential/issue
            Period: 60
            Stat: Sum
        - Id: errorPercentage
          Label: errorPercentage
          ReturnData: false
          Expression: (error/invocations)*100
        - Id: error
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: 5XXError
              Dimensions:
                - Name: Method
                  Value: POST
                - Name: ApiName
                  Value: !Sub "${AWS::StackName}-PublicDLApi"
                - Name: Stage
                  Value: !Ref Environment
                - Name: Resource
                  Value: /credential/issue
            Period: 60
            Stat: Sum

  IssueCredential4XXApiGwErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-IssueCredential4XXApiGwErrorAlarm"
      AlarmDescription: !Sub "There has been a small proportion of 4XX errors on the IssueCredential endpoint. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-warning-alert-topic
      AlarmActions:
        - !ImportValue platform-alarm-warning-alert-topic
      InsufficientDataActions: [ ]
      Dimensions: [ ]
      EvaluationPeriods: 5
      DatapointsToAlarm: 2
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
      Metrics:
        - Id: errorThreshold
          Label: errorThreshold
          ReturnData: true
          Expression: IF(invocations<2 || error<2,0,errorPercentage)
        - Id: invocations
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: Count
              Dimensions:
                - Name: ApiName
                  Value: !Sub "${AWS::StackName}-PublicDLApi"
                - Name: Resource
                  Value: /credential/issue
                - Name: Stage
                  Value: !Ref Environment
                - Name: Method
                  Value: POST
            Period: 60
            Stat: Sum
        - Id: errorPercentage
          Label: errorPercentage
          ReturnData: false
          Expression: (error/invocations)*100
        - Id: error
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: 4XXError
              Dimensions:
                - Name: ApiName
                  Value: !Sub "${AWS::StackName}-PublicDLApi"
                - Name: Resource
                  Value: /credential/issue
                - Name: Stage
                  Value: !Ref Environment
                - Name: Method
                  Value: POST
            Period: 60
            Stat: Sum

  IssueCredentialThrottleAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: "DeployAlarms"
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-critical-alert-topic
      OKActions:
        - !ImportValue platform-alarm-critical-alert-topic
      InsufficientDataActions: []
      AlarmDescription: !Sub "Trigger if the ${IssueCredentialFunction} lambda throttles. ${SupportManualURL}"
      AlarmName: !Sub "${AWS::StackName}-IssueCredentialFunction-throttles"
      MetricName: Throttles
      Namespace: AWS/Lambda
      Statistic: Sum
      Dimensions:
        - Name: FunctionName
          Value: !Ref IssueCredentialFunction
      TreatMissingData: notBreaching
      Period: 60 # This is the minimum value for the AWS Namespace
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold

  IssueCredentialFunctionFatalErorMetricFilter:
    Type: AWS::Logs::MetricFilter
    Condition: "DeployAlarms"
    Properties:
      LogGroupName: !Ref IssueCredentialFunctionLogGroup
      FilterPattern: '{ $.level = "FATAL" || $.message = "Unhandled Exception:*" }'
      MetricTransformations:
        -
          MetricValue: "1"
          MetricNamespace: !Sub "${AWS::StackName}/LogMessages"
          MetricName: "IssueCredentialFunction-Fatalerror"

  IssueCredentialFunctionFatalErrorAlarm:
    DependsOn:
      - "IssueCredentialFunctionFatalErorMetricFilter"
    Type: AWS::CloudWatch::Alarm
    Condition: "DeployAlarms"
    Properties:
      AlarmName: !Sub "${AWS::StackName}-IssueCredentialFunction-FatalErrorAlarm"
      AlarmDescription: !Sub "Trigger an alarm when Fatal Error occurs. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-warning-alert-topic
      AlarmActions:
        - !ImportValue platform-alarm-warning-alert-topic
      InsufficientDataActions: [ ]
      MetricName: IssueCredentialFunction-Fatalerror
      Namespace: !Sub "${AWS::StackName}/LogMessages"
      Statistic: Sum
      Dimensions: [ ]
      Period: 60
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

Outputs:
  StackName:
    Description: "CloudFormation stack name"
    Value: !Sub "${AWS::StackName}"

  PublicDrivingPermitApiUrl:
    Description: "URL for the Driving Permit API /check-driving-licence resource"
    Value: !Sub "https://${PublicDrivingPermitApi}.execute-api.${AWS::Region}.amazonaws.com/${Environment}/identity-check"
    Export:
      Name: !Sub ${AWS::StackName}-PublicDrivingPermitApiUrl

  CredentialIssueApiUrl:
    Description: "URL for the Driving Permit API /credential/issue resource"
    Value: !Sub "https://${PublicDrivingPermitApi}.execute-api.${AWS::Region}.amazonaws.com/${Environment}/credential/issue"
    Export:
      Name: !Sub ${AWS::StackName}-CredentialIssueApiUrl

  DrivingPermitApiBaseUrl:
    Description: "Base url of the Driving Permit CRI API, please reference the PublicDrivingPermitApiBaseUrl"
    Value: !Sub "https://${PublicDrivingPermitApi}.execute-api.${AWS::Region}.amazonaws.com/${Environment}/"
    Export:
      Name: !Sub ${AWS::StackName}-DrivingPermitApiBaseUrl

  DrivingPermitApiGatewayId:
    Description: "API GatewayID of the public Driving Permit CRI API, please reference the PublicDrivingPermitApiBaseUrl"
    Value: !Sub "${PublicDrivingPermitApi}"
    Export:
      Name: !Sub ${AWS::StackName}-DlApiGatewayId

  PublicDrivingPermitApiBaseUrl:
    Description: "Base url of the public Driving Permit CRI API"
    Value: !Sub "https://${PublicDrivingPermitApi}.execute-api.${AWS::Region}.amazonaws.com/${Environment}/"
    Export:
      Name: !Sub ${AWS::StackName}-PublicDrivingPermitApiBaseUrl

  PublicDrivingPermitApiGatewayId:
    Description: "API GatewayID of the public Driving Permit CRI API"
    Value: !Sub "${PublicDrivingPermitApi}"
    Export:
      Name: !Sub ${AWS::StackName}-PublicDlApiGatewayId

  PrivateDrivingPermitApiBaseUrl:
    Description: "Base url of the privateDrivingPermit CRI API"
    Value: !Sub "https://${PrivateDrivingPermitApi}.execute-api.${AWS::Region}.amazonaws.com/${Environment}/"
    Export:
      Name: !Sub ${AWS::StackName}-PrivateDrivingPermitApiBaseUrl

  PrivateDrivingPermitApiGatewayId:
    Description: "API GatewayID of the private Driving Permit CRI API"
    Value: !Sub "${PrivateDrivingPermitApi}"
    Export:
      Name: !Sub ${AWS::StackName}-PrivateDlApiGatewayId
